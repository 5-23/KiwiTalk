on:
  pull_request:
    types:
    - closed
    branches:
    - dev

name: Release new version
jobs:
  draft:
    if: contains(github.event.pull_request.labels.*.name, 'release') && github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - run: |
          git config user.name 'KiwiTalk Continuous Integration'
          git config user.email '41898282+github-actions[bot]@users.noreply.github.com'

      - id: get_version
        run: |
          echo version=$(cargo metadata --format-version 1 --no-deps | \
            jq --raw-output '.packages | .[] | select(.name == "kiwi-talk-app").version') >> "$GITHUB_OUTPUT"

      - name: push new tag
        run: |
          git tag v${{ steps.get_version.outputs.version }}
          git push origin v${{ steps.get_version.outputs.version }}

      - name: draft
        run: |
          gh release create v${{ steps.get_version.outputs.version }} --generate-notes -d -t "KiwiTalk ${{ steps.get_version.outputs.version }}"
        env:
          GH_TOKEN: ${{ github.token }}

  build:
    needs: [draft]
    runs-on: ${{ matrix.platform }}
    strategy:
      matrix:
        platform: [macos-latest, ubuntu-20.04, windows-latest]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v3
        with:
          node-version: 16

      - uses: pnpm/action-setup@v2

      - uses: dtolnay/rust-toolchain@stable

      - name: install dependencies (ubuntu only)
        if: matrix.platform == 'ubuntu-20.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.0-dev libappindicator3-dev librsvg2-dev patchelf

      - uses: Swatinem/rust-cache@v2

      - name: install frontend packages
        run: pnpm install

      - uses: JonasKruckenberg/tauri-build@v1
        id: tauri_build

      - name: upload
        run: gh release upload v${{ needs.draft.outputs.version }} ${{ join(fromJSON(steps.tauri_build.outputs.artifacts), ' ') }}
        env:
          GH_TOKEN: ${{ github.token }}

  publish:
    needs: [build]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - run: |
          git config user.name 'KiwiTalk Continuous Integration'
          git config user.email '41898282+github-actions[bot]@users.noreply.github.com'
          
      - uses: actions/setup-node@v3
        with:
          node-version: 16
          registry-url: https://registry.npmjs.org/

      - uses: dtolnay/rust-toolchain@stable
      
      - uses: Swatinem/rust-cache@v2

      - name: install cargo-release
        run: cargo install cargo-release

      - name: publish crates, bump version, commit
        run: |
          cargo release minor \
            --workspace \
            --no-publish \
            --no-confirm \
            --no-tag \
            --no-push \
            --execute
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CRATES_IO_TOKEN }}

      - name: bump package.json version, commit
        run: |
          npm version minor

      - uses: peter-evans/create-pull-request@v5
        with:
          delete-branch: true
          branch: release/bump-version
          base: dev
          title: "chore: bump versions after release"
          body: |
            Bump package.json and Cargo.toml versions after release.
            This PR has been auto-generated

      - run: gh release edit v${{ needs.draft.outputs.version }} --draft=false --verify-tag
        env:
          GH_TOKEN: ${{ github.token }}
